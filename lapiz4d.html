<!DOCTYPE html>
<html lang="es" xmlns="http://www.w3.org/1999/xhtml">
<head><title>Lapiz4D</title>
<meta charset="UTF-8">
<meta       name = "viewport"     content = "width=device-width, initial-scale=1.0">
</head>
<body>

<svg id='panel4d' preserveAspectRatio='none' viewBox='0 0 512 512' style='position: absolute; display: block; left: 0px; top: 0px;width:512px; height:512px; outline: silver solid 1px;'>
</svg>
<script>
var x = 256, y = 256, factorx = 1, factory = 1;
var xanterior = x, yanterior = y;
var izquierda = 0, arriba = 0;
var pruta ="", sty="", styt="";
var dibujando = 0, ruta, pa = '', pi = '', pix, piy, conta = 0, contatext=0, actual='';
var moviendoblip = '', seleccionado = '', rutaseleccionada, colorfil = 'black', colorstroke = '#000000', grueso = '1';
var m1 = 1, m2 = 1;
var svg = document.getElementById('panel4d'); 
svg.style.cursor = 'none';
var hundido = 0;
window.onload=panel();
lapiz4d();
function panel() {
	ancho = Math.max(document.documentElement.clientWidth,  window.innerWidth);	
	alto  = Math.max(document.documentElement.clientHeight, window.innerHeight)- 2; 	
	if (ancho > alto) { lado = alto; } else { lado = ancho; }	
	svg.setAttribute('style', 'position: absolute; display: block; left: 0px; top: 0px; outline: silver solid 1px; width:' + lado + 'px;height:' + lado + 'px;');
	svg.style.cursor = 'none';
	var rect = svg.getBoundingClientRect();
	izquierda = rect.left;
	arriba = rect.top;
	factorx = 512/rect.width;
	factory = 512/rect.height;
}
// event listener
if (window.addEventListener) {
	svg.addEventListener('mousemove', muevemouse, false);
	svg.addEventListener('mousedown', abajomouse, false);
	svg.addEventListener('mouseup', arribamouse, false);

	svg.addEventListener('touchmove', muevetouch, false);
	svg.addEventListener('touchstart', iniciatouch, false);
	svg.addEventListener('touchend', fintouch, false);
} else {
	svg.onmousemove = muevemouse;
	svg.onmousedown = abajomouse;
	svg.onmouseup = arribamouse;

	svg.ontouchmove = muevetouch;
	svg.ontouchstart = iniciatouch;
	svg.ontouchend = fintouch;
	
}
function abajomouse(e) {	hundido = 1; pi = ''; ruta = '';
	e = e || window.event;     var px = e.pageX - izquierda;    var py = e.pageY - arriba;
    x = parseInt(px * factorx);
    y = parseInt(py * factory);	
	if (xanterior == x && yanterior == y){ return };
	if(hundido==1){dibuja();}
	xanterior = x, yanterior = y;
	lapiz4d();
}	
function arribamouse(e) {	hundido = 0;}	
function iniciatouch(e){	hundido = 1; pi = ''; ruta = '';}
function fintouch(e){	    hundido = 0;}
// muevetouch
function muevetouch(e){
	var touch = e.touches[0];	var px = touch.pageX - izquierda;    var py = touch.pageY - arriba;
	if (e.touches.length >= 2) {
		//e.preventDefault();
		return;
	}
	x = parseInt(px * factorx);
    y = parseInt(py * factory);	
	if (xanterior == x && yanterior == y){ return };
	dibuja();
	lapiz4d();
	e.preventDefault();
}
//mouse mueve 
function muevemouse(e) {
    e = e || window.event;     var px = e.pageX - izquierda;    var py = e.pageY - arriba;
    x = parseInt(px * factorx);
    y = parseInt(py * factory);	
	if (xanterior == x && yanterior == y){ return };
	if(hundido==1){dibuja();}
	xanterior = x, yanterior = y;
	lapiz4d();
}
function circulo(){
	var radio = 1; 
	var circle = document.createElementNS("http://www.w3.org/2000/svg", "circle"); 
	circle.setAttribute("cx", x); 
	circle.setAttribute("cy", y); 
	circle.setAttribute("r", radio); 
	circle.setAttribute("stroke", "none"); 
	circle.setAttribute("fill", "red"); 
	svg.appendChild(circle);
}
function dibuja(){
	sty = "fill: " + colorfil + "; stroke: " + colorstroke + "; stroke-width: " + grueso + "; stroke-linecap: round;stroke-linejoin: round;";
	if (pi === '') {
		actual = 'Vector' + conta;
		conta++;
		while (document.getElementById(actual)) {
			actual = 'Vector' + conta;
			conta++;
		}
		pix = x;
		piy = y;
		pi = x + ',' + y;	
		pa = pi;
		ruta = pa;
		poli4d(actual, ruta, sty);
		seleccionado = document.getElementById(actual);
	} else {
		m1 = x / y;
		if(m1 != m2) {
			circulo();
			ruta = ruta + ',' + x + ',' + y;
			poli4d(actual, (ruta + ',' + pix + ',' + piy), sty);
			m2 = m1;
		}
		pa = x + ',' + y;
	}
}
function trespuntosados(p1,p2,p3){
	var x1 = parseInt(p1.split(',')[0]);
	var y1 = parseInt(p1.split(',')[1]);
	var x2 = parseInt(p2.split(',')[0]);
	var y2 = parseInt(p2.split(',')[1]);
	var x3 = parseInt(p3.split(',')[0]);
	var y3 = parseInt(p3.split(',')[1]);
	var m1 = (y2 - y1) / (x2 - x1);
	var m2 = (y3 - y2) / (x3 - x2);
	if (m1 == m2) {
		return true;
	} else {
		return false;
	}

}
function lapiz4d(){
	pruta = x + "," + y + " " + (x) + "," + (y - 2) + "," + (x + 7) + "," + (y - 7) + "," + (x + 9) + "," + (y - 5) + "," + (x + 2) + "," + (y) + "," + x + "," + y;
	var pcolor = "yellow";
	sty = 'fill: ' + pcolor + '; stroke: black; stroke-width: 0.333; stroke-linecap: round; stroke-linejoin: round;';
	poli4d("_lapiz", pruta, sty);
}
//funciones
function poli4d(pid, pts, sty) {if (pts.indexOf("undefined")<0 && pts.indexOf("NaN")<0){var o4d; if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS("http://www.w3.org/2000/svg", "polyline"); o4d.setAttribute("id", pid); o4d.setAttribute("shape-rendering", "geometricPrecision"); } o4d.setAttribute("points", pts);if (sty !== " ") {o4d.setAttribute("style", sty);}if (!document.getElementById(pid)) {document.getElementById("panel4d").appendChild(o4d);}}}
</script>  
</body>
</html>