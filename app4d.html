<html lang="es" xmlns="http://www.w3.org/1999/xhtml">
<head><title>MarIA</title>
<meta http-equiv = "Expires"      content = "Tue, 25 Abr 1990 09:30:00 -0700">
<meta http-equiv = "Content-Type" content = "text/html; charset=UTF-8">
<meta name = "keywords"           content = "Tercera Edad">
<meta name = "description"        content = "IA para la Tercera Edad">
<meta name = "Autor"              content = "jorge4d">
<meta name = "Latitud"            content = "6.336830">
<meta name = "Longitud"           content = "-75.601475">
<meta name = "Altitud"            content = "2500.04">
<meta name = "Momento"            content = "2024/04/28_10:02:00">
<meta name = "Email"              content = "jorgejuliasanchez@hotmail.com">
<link rel="shortcut icon" href="4D.ico">
<style>
.rotado{transform: rotateY(180deg); -webkit-transform:rotateY(180deg); -moz-transform:rotateY(180deg);}
body{font-family: Verdana, sans-serif; line-height: 1.5;}
</style>
<script src="./libjs/face-api.js"></script>
</head>
<body>
<img      id="img4d"      class="rotado"   style='display: block; width: 512px; height: 512px; position: absolute; left: 0; right: 0; top: 0px;  margin: 0 auto;'  width="512px" height="512px" src='maria.jpg'>
<canvas   id='tempCanvas' class="rotado"   style="display: block; width: 512px; height: 512px; position: absolute; left: 0; right: 0; top: 0px;  margin: 0 auto;"  width="512px" height="512px"></canvas>
<video    id="video"      class="rotado"   style="display: none;  width: 512px; height: 384px; position: absolute; left: 0; right: 0; top: 64px; margin: 0 auto;background: orange; " playsinline autoplay ></video>
<canvas   id='myCanvas4D' class="rotado"   style="display: block; width: 384px; height: 384px; position: absolute; left: 0; right: 0; top: 64px; margin: 0 auto; " width="384px" height="384px"></canvas>
<svg      id="panel4d"    class="rotado"   style="display: block; width: 512px; height: 512px; position: absolute; left: 0; right: 0; top:  0px; margin: 0 auto; outline: silver solid 1px;" viewBox="0 0 512 512"></svg>
<svg      id="hoja4d"                      style="display: block; width: 512px; height: 512px; position: absolute; left: 0; right: 0; top:  0px; margin: 0 auto; outline: silver solid 1px;" viewBox="0 0 512 512">
    <text id="X"           x="68"  y="18"  style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:18px" shape-rendering="geometricPrecision" ></text>
    <text id="Y"           x="446" y="18"  style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:18px" shape-rendering="geometricPrecision" direction="rtl" unicode-bidi="embed" ></text>
    <text id="Z"           x="446" y="508" style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:18px" shape-rendering="geometricPrecision" direction="rtl" unicode-bidi="embed" ></text>
    <text id="T"           x="68"  y="508" style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:18px" shape-rendering="geometricPrecision" ></text>
    <text id="robot1"      x="68"  y="40"  style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:14px"></text>
    <text id="robot3"      x="68"  y="60"  style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:14px"></text>
    <text id="subtitulos1" x="68"  y="468" style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:16px"></text>
    <text id="subtitulos2" x="68"  y="488" style="fill: silver; stroke: none; stroke-width: 1; font-family:monospace; font-size:16px"></text>
    
    <polyline                                     style="fill: silver ; stroke: silver ; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="64,0 60,4 60,59 64,64 59,60 4,60 0,64 64,64 64,0"></polyline>
	<circle   id="circulo1" cx="30" cy="30" r="22" fill="none" stroke="silver" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle>
	<polyline id="palo1"                          style="fill: silver ; stroke: white ; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;" points="27,26 27,4 33,4 33,26 27,26"></polyline>
	<polyline id="96" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="0,0 64,0 64,64 0,64 0,0"><title>OnOff</title></polyline>
    
    <polyline                                     style="fill: silver ; stroke: silver ; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"     points="64,64 60,68 60,123 64,128 59,124 4,124 0,128 64,128 64,64"></polyline>
	<polyline id="camara"                         style="fill: none ; stroke: silver ; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;" points="10,75 38,75 50,104 50,80 38,113 10,113 10,75"></polyline>
    <polyline id="97" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="0,64 64,64 64,128 0,128 0,64"><title>Video</title></polyline>
    
    <polyline                                     style="fill: silver ; stroke: silver ; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"     points="64,128 60,132 60,187 64,192 59,188 4,188 0,192 64,192 64,192"></polyline>
    <polyline id="bsilueta" points="17,152 16,154 17,157 17,161 18,166 20,170 23,174 27,177 33,179 39,177 42,174 45,171 47,168 48,163 48,159 49,155 49,152 " style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bcejai"   points="19,139 22,138 24,138 26,139 28,140 "                                                                                     style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bcejad"   points="40,139 42,138 45,137 47,137 50,139 "                                                                                     style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bnariz"   points="32,150 32,152 32,156 32,160 28,161 30,162 32,163 34,162 36,161 "                                                         style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bojoi"    points="20,144 22,142 25,142 27,144 25,145 22,145 20,144 "                                                                       style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bojod"    points="40,144 42,142 45,142 48,144 45,145 42,145 40,144 "                                                                       style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bbocae"   points="25,168 28,168 31,166 33,167 34,167 37,167 40,168 36,170 34,170 32,171 30,170 27,169 25,168 "                             style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="bbocai"   points="28,168 32,168 33,168 35,168 38,168 35,169 33,169 31,169 28,168 "                                                         style="fill: none ; stroke: silver; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;"></polyline>
    <polyline id="98" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"         points="0,128 64,128 64,192 0,192 0,128"><title>Detectfaces</title></polyline>
    
    <polyline                                     style="fill: silver ; stroke: silver ; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="64,192 60,196 60,251 64,256 59,252 4,252 0,256 64,256 64,256"></polyline>
    <polyline id="canvasicon"                     style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;" points="33,194 33,204 39,204 38,199 39,204 48,204 48,226 43,226 48,249 45,237 33,237 33,243 33,226 43,226 23,226 19,249 21,237 33,237 21,237 23,226 18,226 18,204 27,204 28,199 27,204 33,204 33,194 "></polyline>
    <polyline id="99" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"     points="0,192 64,192 64,256 0,256 0,192"><title>Canvasfilter</title></polyline>
    
    <polyline                                      style="fill: silver ; stroke: silver ; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="64,256 60,260 60,315 64,320 59,316 4,316 0,320 64,320 64,320"></polyline>
    <polyline id="w1112" points="10,266 30,266"    style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w1112</title></polyline><polyline shape-rendering="geometricPrecision" id="w1122" points="10,266 30,286" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w1122</title></polyline><polyline shape-rendering="geometricPrecision" id="w1132" points="10,266 30,306" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w1132</title></polyline><polyline shape-rendering="geometricPrecision" id="w2112" points="10,286 30,266" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w2112</title></polyline><polyline shape-rendering="geometricPrecision" id="w2122" points="10,286 30,286" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w2122</title></polyline><polyline shape-rendering="geometricPrecision" id="w2132" points="10,286 30,306" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w2132</title></polyline><polyline shape-rendering="geometricPrecision" id="w3112" points="10,306 30,266" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w3112</title></polyline><polyline shape-rendering="geometricPrecision" id="w3122" points="10,306 30,286" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w3122</title></polyline><polyline shape-rendering="geometricPrecision" id="w3132" points="10,306 30,306" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w3132</title></polyline><polyline shape-rendering="geometricPrecision" id="w1213" points="30,266 50,266" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w1213</title></polyline><polyline shape-rendering="geometricPrecision" id="w1223" points="30,266 50,286" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w1223</title></polyline><polyline shape-rendering="geometricPrecision" id="w1233" points="30,266 50,306" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w1233</title></polyline><polyline shape-rendering="geometricPrecision" id="w2213" points="30,286 50,266" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w2213</title></polyline><polyline shape-rendering="geometricPrecision" id="w2223" points="30,286 50,286" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w2223</title></polyline><polyline shape-rendering="geometricPrecision" id="w2233" points="30,286 50,306" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w2233</title></polyline><polyline shape-rendering="geometricPrecision" id="w3213" points="30,306 50,266" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w3213</title></polyline><polyline shape-rendering="geometricPrecision" id="w3223" points="30,306 50,286" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w3223</title></polyline><polyline shape-rendering="geometricPrecision" id="w3233" points="30,306 50,306" style="fill: none; stroke: silver; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;"><title>w3233</title></polyline><circle shape-rendering="geometricPrecision" id="n11" cx="10" cy="266" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n11</title></circle><circle shape-rendering="geometricPrecision" id="n21" cx="10" cy="286" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n21</title></circle><circle shape-rendering="geometricPrecision" id="n31" cx="10" cy="306" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n31</title></circle><circle shape-rendering="geometricPrecision" id="n12" cx="30" cy="266" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n12</title></circle><circle shape-rendering="geometricPrecision" id="n22" cx="30" cy="286" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n22</title></circle><circle shape-rendering="geometricPrecision" id="n32" cx="30" cy="306" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n32</title></circle><circle shape-rendering="geometricPrecision" id="n13" cx="50" cy="266" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n13</title></circle><circle shape-rendering="geometricPrecision" id="n23" cx="50" cy="286" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n23</title></circle><circle shape-rendering="geometricPrecision" id="n33" cx="50" cy="306" r="3" style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;"><title>n33</title></circle>
    <polyline id="100" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"   points="0,256 64,256 64,320 0,320 0,256"><title>Train</title></polyline>
    
    <polyline                                      style="fill: silver; stroke: silver; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="64,320 60,324 60,379 64,384 59,380 4,380 0,384 64,384 64,384"></polyline>
    <circle   id="cirtest" cx="30" cy="352" r="20" fill="none" stroke="silver" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle>
    <polyline id="chulito"                         style="fill: white; stroke: silver; stroke-width: 2; stroke-linecap: round;stroke-linejoin: round;" points="54,327 46,336 39,346 33,356 29,365 26,359 22,354 18,350 14,347 14,346 16,345 20,346 24,348 27,351 28,352 29,353 30,351 32,347 35,343 39,338 43,333 47,330 50,328 54,327 "></polyline>
    <polyline id="101" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"     points="0,320 64,320 64,384 0,384 0,320"><title>Test</title></polyline>
    
    <polyline                                      style="fill: silver; stroke: silver; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="64,384 60,388 60,443 64,448 59,444 4,444 0,448 64,448 64,448"></polyline>
    <polyline id="pinon"                           style="fill: none; stroke: silver; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="27,392 32,392 33,395 37,396 41,394 44,397 43,400 45,403 48,403 50,408 48,411 48,415 51,418 49,423 45,422 43,425 45,429 40,432 38,429 34,430 33,434 28,434 27,430 23,429 21,432 17,430 18,426 15,423 11,423 10,419 12,417 12,412 10,410 11,405 14,405 17,402 16,398 19,395 22,397 25,396 27,392 "></polyline>
    <circle   id="cirpinon" cx="30" cy="413" r="14" fill="white" stroke="silver" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle>
    <polyline id="102" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"     points="0,384 64,384 64,448 0,448 0,384"><title>Config</title></polyline>
    
    <polyline                                      style="fill: silver ; stroke: silver ; stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;"      points="64,448 60,452 60,507 64,512 59,508 4,508 0,512 64,512 64,448"></polyline>
	<ellipse  id="elipse1" cx="30" cy="488" rx="10" ry="6"  fill="none"  stroke="silver" stroke-width="3" />
	<ellipse  id="elipse2" cx="30" cy="474" rx="10" ry="14" fill="silver" stroke="white" stroke-width="3" />
	<polyline id="palo2"                           style="fill: silver ; stroke: none ; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;" points="27,506 27,494 33,494 33,506 27,506"></polyline>
	<polyline id="103" onclick="ejecutar(this.id)" style="cursor: pointer; cursor: hand;  stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" 	points="0,448 64,448 64,512 0,512 0,448"><title>Microfono</title></polyline>

	<polyline style="stroke: silver; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,0 512,0 512,64 448,64 448,0"></polyline>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,0 512,0 512,64 448,64 448,0"></polyline>
    <text x="452" y="14"   style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:14px" shape-rendering="geometricPrecision" >Puntaje</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,64 512,64 512,128 448,128 448,64"></polyline>
    <text x="464" y="76"   style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Feliz</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,128 512,128 512,192 448,192 448,128"></polyline>
    <text x="450" y="140"  style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Sorprendido</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,192 512,192 512,256 448,256 448,192"></polyline>
    <text x="464" y="204"  style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Neutro</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,256 512,256 512,320 448,320 448,256"></polyline>
    <text x="464" y="268"  style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Triste</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,320 512,320 512,384 448,384 448,320"></polyline>
    <text x="464" y="332"  style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Bravo</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,384 512,384 512,448 448,448 448,384"></polyline>
    <text x="453" y="396"  style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Disgustado</text>
	<polyline style="stroke: black; fill: rgba(255,255,255,0.1); stroke-width: 1; stroke-linecap: round; stroke-linejoin: round;" points="448,448 512,448 512,512 448,512 448,448"></polyline>
    <text x="456" y="460"  style="fill: silver;  stroke: none;  stroke-width: 1; font-family:monospace; font-size:10px" shape-rendering="geometricPrecision" >Temeroso</text>
</svg>
<div id="divconfig" style="background-color: white; display: none; width:384px;height:384px;position:absolute;left: 0px;top:64px;right: 0;margin: 0 auto; ">
    <form method="POST" style="text-align: center;"> 
        <div>
            <button type="button" id="Nuevo" onclick="ubica()">Ubicame</button>  
            <button type="button" id="Guardar" onclick="grabaconfig()">Grabar</button>  
        </div>
        <div >
            <div style="font-size: 22px; padding: 8px; font-weight: bolder; text-align: center;">Config</div>
            <span style="vertical-align: middle;">
                <div style="display: inline-block; text-align: left;">
                    <table>
                        <tr><th>Autor</th><td><input  type="text" id="usuario"  name="usuario"  value="" disabled></td></tr>
                        <tr><th> ° Lat</th><td><input type="text" id="latitud"  name="latitud"  value="" disabled></td></tr>
                        <tr><th> ° Lon</th><td><input type="text" id="longitud" name="longitud" value="" disabled></td></tr>
                        <tr><th>mt Alt</th><td><input type="text" id="altitud"  name="altitud"  value="" disabled></td></tr>
                        <tr><th>s  Tim</th><td><input type="text" id="instante" name="instante" value="" disabled></td></tr>  
                        <tr><th>Fecha Nac</th><td><input type="text" id="fechanac" name="instante" value="" disabled></td></tr>                          
                    </table>
                </div>
            </span>
        </div>           
    </form>
</div>
<script>
const video   = document.getElementById('video');
var canvas    = document.getElementById("myCanvas4D"); 
var canvas4d  = canvas.getContext("2d");
var tempCanvas = document.createElement("canvas");
var tempCtx = tempCanvas.getContext("2d");
var dataURL = "";
var izquierda, arriba, ancho, alto, lado;
recuadro();
function recuadro(){
    svgRect = document.getElementById('panel4d').getBoundingClientRect();
    izquierda = svgRect.left;
    arriba    = svgRect.top;
    ancho     = svgRect.width;
    alto      = svgRect.height;
}
window.onload=panel();window.addEventListener('resize', function (event) { panel(); });
function panel() {
    ancho = Math.max(document.documentElement.clientWidth,  window.innerWidth);
    alto  = Math.max(document.documentElement.clientHeight, window.innerHeight)-2; 
    if (ancho > alto) { lado = alto; } else { lado = ancho; }
    document.getElementById('img4d').setAttribute(     'style', 'position:absolute; left: 0; right: 0; top: 0; margin:0 auto; outline: silver solid 1px;  width:' + lado + 'px;height:' + lado + 'px;');
    document.getElementById('tempCanvas').setAttribute('style', 'position:absolute; left: 0; right: 0; top: 0; margin:0 auto; outline: silver solid 1px;  width:' + lado + 'px;height:' + lado + 'px;');
    document.getElementById('panel4d').setAttribute(   'style', 'position:absolute; left: 0; right: 0; top: 0; margin:0 auto; outline: silver solid 1px;  width:' + lado + 'px;height:' + lado + 'px;');
    document.getElementById('video').setAttribute(     'style', 'position:absolute; left: 0; right: 0; top: 0px; margin: 0 auto; width:' + Math.round(lado) + 'px;height:' + Math.round(lado) + 'px;');
    document.getElementById('hoja4d').setAttribute(    'style', 'position:absolute; left: 0; right: 0; top: 0px; margin: 0 auto; width:' + lado + 'px;height:' + lado + 'px;');
    document.getElementById('myCanvas4D').setAttribute('style', 'position:absolute; left: 0; right: 0; top: ' + Math.round(lado / 8) + 'px; margin: 0 auto; width:' + Math.round(lado * 0.75) + 'px;height:' + Math.round(lado * 0.75) + 'px;');
    document.getElementById('divconfig').setAttribute( 'style', 'background-color: white; display: none; position:absolute; left: 0;right: 0;top: ' + Math.round(lado / 8) + 'px; margin: 0 auto; width:' + Math.round(lado * 0.75) + 'px;height:' + Math.round(lado * 0.75) + 'px;');
    recuadro();
}

var pusuario  = "Tu", platitud  = "0", plongitud = "0", paltitud  = "0", pinstante  = "0", pfechanac  = "0";
var pmensaje   ='Soy María, tu inteligencia Artificial';
main();
function main() {
    fetch('/config')
    .then((response) => {if (!response.ok) {throw new Error('No se pudo obtener la configuración');} return response.json(); })
    .then((config) => {    pusuario   = config.Usuario;     platitud   = config.Latitud;     plongitud  = config.Longitud;     paltitud   = config.Altitud;     pinstante  = config.Instante;     pfechanac  = config.FechaNac;     })
    .catch((error) => {console.error('Error al obtener la configuración:', error); });
}

var prendido       = 0;
var reconoceactivo = 0;  
var canvasactivo   = 0; 
var micactivo      = 0;
var rednactivo     = 0;
var testactivo     = 0;
var configactivo   = 0;
var videoactivo    = 0;

function hablar(texto){
  document.getElementById("robot1").textContent=document.getElementById("robot3").textContent;
  document.getElementById("robot3").textContent=texto;
  let msg = new SpeechSynthesisUtterance(texto); 
  msg.lang = "es";
  speechSynthesis.speak(msg);
}
Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri('/models/tiny_face_detector_model-weights_manifest.json'),
    faceapi.nets.faceLandmark68Net.loadFromUri('/models/face_landmark_68_model-weights_manifest.json'),
    faceapi.nets.faceRecognitionNet.loadFromUri('/models/face_recognition_model-weights_manifest.json'),
    faceapi.nets.faceExpressionNet.loadFromUri('/models/face_expression_model-weights_manifest.json'),
    faceapi.nets.ageGenderNet.loadFromUri('/models/age_gender_model-weights_manifest.json')
    ]).then(() => { pulso(); });
function getCurrentTime() {  return performance.now();}
function pulso(timestamp) {
    if(reconoceactivo ===1){
        detectFaces()
    };
    const timeInMilliseconds = getCurrentTime();
    document.getElementById('T').textContent = numeroconcomas((timeInMilliseconds/1000).toFixed(3));
    requestAnimationFrame(pulso);
}
if (window.addEventListener) { document.addEventListener('keydown', teclas, false); } else { document.onkeydown = teclas; }
function teclas(e) { e = window.event || e; ejecutar(e.keyCode); }
function ejecutar(este) {
	ptecla = '', ptec = '';
	if ((este == 96  || este == 48 || este == 80))  {ptecla = '0'; ptec = '96';  iniciar();   }
	if ((este == 97  || este == 35))                {ptecla = '1'; ptec = '97';  video4d();   }
	if ((este == 98  || este == 40))                {ptecla = '2'; ptec = '98';  reconoce4d();}
	if ((este == 99  || este == 34 || este == 84))  {ptecla = '3'; ptec = '99';	 pcanvas4d(); }
	if ((este == 100 || este == 37 || este == 73))  {ptecla = '4'; ptec = '100'; redn4d();    }
	if ((este == 101 || este == 12))                {ptecla = '5'; ptec = '101'; test4d();    }
	if ((este == 102 || este == 39))                {ptecla = '6'; ptec = '102'; config4d();  }
	if ((este == 103 || este == 36 || este == 73))  {ptecla = '7'; ptec = '103'; microfono4d()}
	if ((este == 104 || este == 38))                {ptecla = '8'; ptec = '104'; }
	if ((este == 105 || este == 33 || este == 90))  {ptecla = '9'; ptec = '105'; }
	if ((este == 65  || este == 76 || este == 109)) {ptecla = 'A'; ptec = '65';  }
	if ((este == 66  || este == 82 || este == 107)) {ptecla = 'B'; ptec = '66';  }
	if ((este == 67  || este == 83 || este == 106)) {ptecla = 'C'; ptec = '67';  }
	if ((este == 68  || este == 111))               {ptecla = 'D'; ptec = '68';  }
	if ((este == 69  || este == 13))                {ptecla = 'E'; ptec = '69';  }
	if ((este == 70  || este == 46 || este == 110)) {ptecla = 'F'; ptec = '70';  }
}
function iniciar(){
  if (prendido==0){
    prendido=1;    
    document.getElementById("circulo1").style.stroke = 'red';
	document.getElementById("palo1").style.fill = 'red';
    hablar(pmensaje);
    document.getElementById('X').textContent = "Lon " + plongitud + "°";    
    document.getElementById('Y').textContent = "Lat " + platitud  + "°";    
    document.getElementById('Z').textContent = "Alt " + paltitud  + "mt";    
    document.getElementById('T').textContent = "Tim " + pinstante;
    fetch('/saludo').then(response => response.text()).then(mensaje    => {hablar(mensaje + " " + pusuario)}).catch(error => {console.error('Supervisar', error);});
    fetch('/instante').then(response => response.text()).then(mensaje  => {hablar("hoy es " + mensaje);}).catch(error     => {console.error('Supervisar', error);});
    videoactivo   = 0; video4d(); 
    micactivo     = 0; microfono4d();
    reconoceactivo= 0; reconoce4d();
    canvasactivo  = 0; pcanvas4d();
  } else {        
	document.getElementById("circulo1").style.stroke = 'silver';
	document.getElementById("palo1").style.fill = 'silver';
    prendido=0;        
	speechSynthesis.cancel();
    videoactivo=1; video4d(); 
    micactivo=1; microfono4d();
    reconoceactivo=1; reconoce4d();
    canvasactivo=1; pcanvas4d();
  }
}
function cambiarColorConfig(color) {
    document.getElementById("cirpinon").style.stroke = color;
    document.getElementById("pinon").style.fill = color;
    document.getElementById("pinon").style.stroke = color;
}
function config4d() {     
    if (configactivo == 1) {        
        configOFF();        
        configactivo = 0;   
        document.getElementById("divconfig").style.display="none"; 
        cambiarColorConfig('silver');      
    } else {        
        configON();
        configactivo = 1;
        document.getElementById("divconfig").style.display="block"; 
        cambiarColorConfig('red');
    }
}
function configON() {
    fetch('/config')
        .then((response) => {
            if (!response.ok) {
                throw new Error('No se pudo obtener la configuración');
            }
            return response.json();
        })
        .then((config) => {
            document.getElementById('usuario').value = config.Usuario;
            document.getElementById('latitud').value = config.Latitud;
            document.getElementById('longitud').value = config.Longitud;
            document.getElementById('altitud').value = config.Altitud;
            document.getElementById('instante').value = config.Instante;
            document.getElementById('fechanac').value = config.FechaNac;
        })
        .catch((error) => {
            console.error('Error al obtener la configuración:', error);
        });
}
function configOFF() {
}
const ubica = () => {
    if (!"geolocation" in navigator) { }
    const onUbicacionConcedida = ubicacion => {
        lat = - ubicacion.coords.latitude;
        lon = ubicacion.coords.longitude;
        document.getElementById('latitud').value = lat;
        document.getElementById('longitud').value = lon;
    }
    const onErrorDeUbicacion = err => {
        document.getElementById('latitud').value = "err";
        document.getElementById('longitud').value = "err";
    }
    const opcionesDeSolicitud = {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    };
    navigator.geolocation.getCurrentPosition(onUbicacionConcedida, onErrorDeUbicacion, opcionesDeSolicitud);
};
function grabaconfig(){
    let usuario = document.getElementById('usuario').value;
    let latitud = document.getElementById('latitud').value;
    let longitud = document.getElementById('longitud').value;
    let altitud = document.getElementById('altitud').value;
    let instante = document.getElementById('instante').value;
    let fechanac = document.getElementById('fechanac').value;

    let config = {
        Usuario: usuario,
        Latitud: latitud,
        Longitud: longitud,
        Altitud: altitud,
        Instante: instante,
        FechaNac: fechanac
    };

    fetch('/grabaconfig', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config),
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error('Error al grabar la configuración');
        }
        return response.text();
    })
    .then((message) => {
        console.log(message);
    })
    .catch((error) => {
        console.error('Error al grabar la configuración:', error);
    });
}

function video4d(){     
    if (videoactivo==1){        
        videoOFF();        
        video.style.display="none"; 
        document.getElementById("camara").style.stroke = 'silver';        
        videoactivo=0;         
    } else {        
        videoON();
        video.style.display="block";     
        document.getElementById("camara").style.stroke = 'red';   
        videoactivo=1;         
    }
}
const constraints = { audio: false,video: { width: { ideal: 512 }, height: { ideal: 384 } }};
var localstream, elId;
async function videoON() {try { const stream = await navigator.mediaDevices.getUserMedia(constraints); exitosa(stream); } catch (e) { alert(`navigator.getUserMedia error:${e.toString()}`);    }}
function exitosa(stream) { window.stream = stream; video.srcObject = stream; localstream = stream;}
function videoOFF(){ video.pause();  video.currentTime = 0; localstream.getTracks()[0].stop(); }

function captura(detecciones) {

    var nombredearchivo1 = pusuario;
    var registro = new Date();
    var fecha = registro.getFullYear() + "/" + ('0' + (registro.getMonth() + 1)).slice(-2) + "/" + ('0' + registro.getDate()).slice(-2);
    fecha += "_" + ('0' + registro.getHours()).slice(-2) + ":" + ('0' + registro.getMinutes()).slice(-2) + ":" +  ('0' + registro.getSeconds()).slice(-2);
    let lmk = detecciones.landmarks.positions.map(obj => [obj._x, obj._y+64]);
    var htm = "<html><head><title>" + pusuario + "</title>" +
        "<meta name='Autor' content='Agente4D' />" + 
        "<meta name='Topico' content='train4d' />" +
        "<meta name='Entidad' content='SVJJ' />" +
        "<meta name='lat' content='" + platitud + "' />" +
        "<meta name='lon' content='" + plongitud + "' />" +
        "<meta name='alt' content='" + paltitud + "' />" +
        "<meta name='tim' content='" + fecha + "' />" +
        "<meta name='nac' content='" + pfechanac + "' />" +
        "<meta name='score' content='" + detecciones.detection.score  + "' />" +
        "<meta name='happy' content='" + detecciones.expressions.happy  + "' />" +      
        "<meta name='surprised' content='" + detecciones.expressions.surprised  + "' />" + 
        "<meta name='neutral' content='" + detecciones.expressions.neutral  + "' />" + 
        "<meta name='sad' content='" + detecciones.expressions.sad  + "' />" +
        "<meta name='angry' content='" + detecciones.expressions.angry  + "' />" +
        "<meta name='disgusted' content='" + detecciones.expressions.disgusted  + "' />" +
        "<meta name='fearful' content='" + detecciones.expressions.fearful  + "' />" +
        "<meta name='age' content='" + detecciones.age  + "' />" +
        "<meta name='des' content='" + detecciones.descriptor + "' />" +
        "<meta name='lmk' content='" + lmk  + "' />" +
        "</head><body style='margin:0;padding:0;'>"+
        "<img style='position:absolute; left:0px;top:0px;width:512px;height:512px;' src='" +dataURL + "'>"+
        "<svg style='position:absolute; left:0px;top:0px;width:512px;height:512px;' id='panel4d'>" +
        document.getElementById('panel4d').innerHTML.trim() +
        "</svg></body></html>";    
    var parametros = "htm=" + encodeURIComponent(htm) + "&nombre=" + encodeURIComponent(nombredearchivo1) ;
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", "/capture", true);
    xmlHttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xmlHttp.onreadystatechange = function() {  
        if (xmlHttp.readyState == 4 && xmlHttp.status == 200)  { 
            console.log(xmlHttp.responseText);  
        }
    }
    xmlHttp.send(parametros);
}
function reconoce4d(){
    if (reconoceactivo==1){        
        reconoceactivo=0;         
        let elementos = ['bsilueta', 'bcejai', 'bcejad', 'bnariz', 'bojoi', 'bojod', 'bbocae', 'bbocai'];
        elementos.forEach(function(elemento) {
            let obj = document.getElementById(elemento);
            if (obj) { obj.style.stroke = 'black'; }
        });        
    } else {        
        reconoceactivo=1;     
        let elementos = ['bsilueta', 'bcejai', 'bcejad', 'bnariz', 'bojoi', 'bojod', 'bbocae', 'bbocai'];
        elementos.forEach(function(elemento) {
            let obj = document.getElementById(elemento);
            if (obj) { obj.style.stroke = 'red'; }
        });   
    }
}
async function detectFaces() {
    var sty="",sty1="";
    canvas4d.drawImage(video, 64, 0, 384, 384, 0, 0, 384, 384);
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors().withFaceExpressions().withAgeAndGender();
    if (detections[0]) {
        canvas4d.drawImage(video, 64, 0, 384, 384, 0, 0, 384, 384);
        sty  ='fill: lime; stroke: black; font-family: Verdana;font-size:20px';
        sty1 ='fill: none ; stroke: lime; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;';
        if ((detections[0].detection.score * 100)>90 ) {
            if ((detections[0].expressions.neutral * 100)>90 ) {
                tempCanvas.width = 512;
                tempCanvas.height = 512;
                tempCtx.drawImage(canvas, 0, 0, 384, 384, 64, 64, 384, 384);
                dataURL = tempCanvas.toDataURL("image/png");
                sty='fill: red; stroke: red; font-family: Verdana;font-size:20px';
                sty1 ='fill: none ; stroke: red; stroke-width: 1; stroke-linecap: round;stroke-linejoin:  round;';
                lineas(detections[0].landmarks.positions,sty1); 
                captura(detections[0]);
            }
        }
        text4d('score', 458, 56, sty, ' ');
        text4d('happy', 458, 120, sty, ' ');
        text4d('surprised', 458, 184, sty, ' ');
        text4d('neutral', 458, 248, sty, ' ');
        text4d('sad', 458, 312, sty, ' ');
        text4d('angry', 458, 376, sty, ' ');
        text4d('disgusted', 458, 440, sty, ' ');
        text4d('fearful', 458, 504, sty, ' ');
        text4d('age', 350, 488, sty, ' ');
        if(detections[0].detection.score>0.1){text4d('score',           458,  56, sty, parseInt(detections[0].detection.score       * 100) + '%');}
        if(detections[0].expressions.happy>0.1){text4d('happy',         458, 120, sty, parseInt(detections[0].expressions.happy     * 100) + '%');}
        if(detections[0].expressions.surprised>0.1){text4d('surprised', 458, 184, sty, parseInt(detections[0].expressions.surprised * 100) + '%');}
        if(detections[0].expressions.neutral>0.1){text4d('neutral',     458, 248, sty, parseInt(detections[0].expressions.neutral   * 100) + '%');}     
        if(detections[0].expressions.sad>0.1){text4d('sad',             458, 312, sty, parseInt(detections[0].expressions.sad       * 100) + '%');}    
        if(detections[0].expressions.angry>0.1){text4d('angry',         458, 376, sty, parseInt(detections[0].expressions.angry     * 100) + '%');}        
        if(detections[0].expressions.disgusted>0.1){text4d('disgusted', 458, 440, sty, parseInt(detections[0].expressions.disgusted * 100) + '%');}
        if(detections[0].expressions.fearful>0.1){text4d('fearful',     458, 504, sty, parseInt(detections[0].expressions.fearful   * 100) + '%');}
        lineas(detections[0].landmarks.positions,sty1); 
    } else {
        canvas4d.fillStyle = 'white';
        canvas4d.fillRect(0, 0, canvas.width, canvas.height);
    }
}
function dibujacanvas(){
     //var imageData = canvas4d.getImageData(0, 0, 384, 384);
    //var data = imageData.data;
    //for(var i = 0; i < data.length; i += 4) {
    //    var red = data[i];
    //    var green = data[i + 1];
    //    var blue = data[i + 2];
    //    if(!(red > 95 && green > 40 && blue > 20 && red-green > 15 && red > blue && green > blue)) {
    //        data[i] = data[i + 1] = data[i + 2] = 255;
    //    }
    //}
    //canvas4d.putImageData(imageData, 0, 0);
}
function lineas(posiciones,estilo) {
    let p = posiciones.map(obj => [obj._x, obj._y+64]);
    pruta = ''; for (var i = 0; i <= 16; i++)  { pruta += p[i][0] + ',' + p[i][1] + ' ' }; poli4dp('__silueta', pruta, estilo);
    pruta = ''; for (var i = 17; i <= 21; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; poli4dp('__cejai', pruta, estilo);
    pruta = ''; for (var i = 22; i <= 26; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; poli4dp('__cejad', pruta, estilo);
    pruta = ''; for (var i = 27; i <= 35; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; poli4dp('__nariz', pruta, estilo);
    pruta = ''; for (var i = 36; i <= 41; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; pruta += p[36][0] + ',' + p[36][1]; poli4dp('__ojoi', pruta, estilo);
    pruta = ''; for (var i = 42; i <= 47; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; pruta += p[42][0] + ',' + p[42][1]; poli4dp('__ojod', pruta, estilo);
    pruta = ''; for (var i = 48; i <= 59; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; pruta += p[48][0] + ',' + p[48][1]; poli4dp('__bocae', pruta, estilo);
    pruta = ''; for (var i = 60; i <= 67; i++) { pruta += p[i][0] + ',' + p[i][1] + ' ' }; pruta += p[60][0] + ',' + p[60][1]; poli4dp('__bocai', pruta, estilo);
}

function calculaedad(fechanac) {
  const today = new Date();
  const birthYear = new Date(fechanac).getFullYear();
  let age = today.getFullYear() - birthYear;
  if (today.getMonth() < new Date(fechanac).getMonth()) {
    age--;
  } else if (today.getMonth() == new Date(fechanac).getMonth() && today.getDate() <= new Date(fechanac).getDate()) {
    age--;
  }
  return age;
}


function cambiarColorTest(color) {
    document.getElementById("cirtest").style.stroke = color;
	document.getElementById("chulito").style.fill = color;

}
function test4d() {     
    if (testactivo == 1) {        
        testOFF();        
        testactivo = 0;   
        cambiarColorTest('black');      
    } else {        
        testON();
        testactivo = 1;
        cambiarColorTest('red');
    }
}

function testON() {
}
function testOFF() {
}

function cambiarColorRedN(color) {
    for (i = 1; i < 3; i++) {
        for (j = 1; j <= 3; j++) {
            for (k = 1; k <= 3; k++) {
                nombre2 = 'w' + j + i + k + (i + 1);
                document.getElementById(nombre2).style.stroke = color;
            }
        }
    }
    for ( i = 1; i <= 3; i++) {
        for (j = 1; j <= 3; j++) {
            nombre = 'n' + j + i;
            document.getElementById(nombre).style.stroke = color;
        }
    }
}
function redn4d() {     
    if (rednactivo == 1) {        
        rednOFF();        
        rednactivo = 0;   
        cambiarColorRedN('black');      
    } else {        
        rednON();
        rednactivo = 1;
        cambiarColorRedN('red');
    }
}

async function rednON() {
	speechSynthesis.cancel();
    video.style.display="none"; 
    document.getElementById("camara").style.stroke = 'black';        
    videoactivo=0;   
    //videoactivo=1; video4d(); 
    micactivo=1; microfono4d();
    reconoceactivo=1; reconoce4d();
    canvasactivo=1; pcanvas4d();
    async function cargarNombresArchivos() {
    const response = await fetch('/dataset/htm');
    const data = await response.json();

    const listaOrdenada = document.createElement('ul');
    data.sort(); // Ordenar alfabéticamente
    let currentIndex = 0;

    function procesarArchivo() {
        if (currentIndex < data.length) {
            const nombreArchivo = data[currentIndex];
            const nombreSinExtension = nombreArchivo.replace('.htm', '');
            callapi4d(nombreSinExtension);
            currentIndex++;
            //requestAnimationFrame(procesarArchivo);
            setTimeout(procesarArchivo, 17);
        } else {
            currentIndex = 0;
            console.log('Procesamiento completo');
            setTimeout(procesarArchivo, 17);
        }
    }
    requestAnimationFrame(procesarArchivo);
    }
    cargarNombresArchivos();
    var nodo = '/caras/';
    function callapi4d(objeto) {
        // limpia4d();
        theUrl = nodo + objeto;
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                pinta4d(xmlHttp.responseText);
            }
        }; xmlHttp.open("GET", theUrl, true);
        xmlHttp.send(null);
    }
    function pinta4d(rta) {
        parser = new DOMParser();
        xmlDoc = parser.parseFromString(rta, "text/xml");
        sty='fill: red; stroke: red; font-family: Verdana;font-size:20px';
        text4d('score', 458, 56, sty, ' ');
        text4d('happy', 458, 120, sty, ' ');
        text4d('surprised', 458, 184, sty, ' ');
        text4d('neutral', 458, 248, sty, ' ');
        text4d('sad', 458, 312, sty, ' ');
        text4d('angry', 458, 376, sty, ' ');
        text4d('disgusted', 458, 440, sty, ' ');
        text4d('fearful', 458, 504, sty, ' ');
        text4d('age', 350, 488, sty, ' ');
        var metas = xmlDoc.getElementsByTagName("head")[0].getElementsByTagName("meta");
        for (var i = 0; i < metas.length; i++) {
            var metaName = metas[i].getAttribute("name");
            var metaContent = metas[i].getAttribute("content");
            switch(metaName) {
                case 'score':
                    if(parseInt(metaContent * 100) > 9){text4d('score', 458, 56, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'happy':
                    if(parseInt(metaContent * 100) > 9){text4d('happy', 458, 120, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'surprised':
                    if(parseInt(metaContent * 100) > 9){text4d('surprised', 458, 184, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'neutral':
                    if(parseInt(metaContent * 100) > 9){text4d('neutral', 458, 248, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'sad':
                    if(parseInt(metaContent * 100) > 9){text4d('sad', 458, 312, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'angry':
                    if(parseInt(metaContent * 100) > 9){text4d('angry', 458, 376, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'disgusted':
                    if(parseInt(metaContent * 100) > 9){text4d('disgusted', 458, 440, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'fearful':
                    if(parseInt(metaContent * 100) > 9){text4d('fearful', 458, 504, sty, parseInt(metaContent* 100) + '%');}
                    break;
                case 'age':
                    if(parseInt(metaContent * 100) > 9){text4d('age', 350, 488, sty, parseInt(metaContent) + ' años');}
                    break;
                case 'des':
                // console.log(metaContent);
                    break;
                case 'lmk':
                // console.log(metaContent);
                    break;
                case 'lat':
                    document.getElementById('Y').textContent = metaContent;
                    break;
                case 'lon':
                    document.getElementById('X').textContent = metaContent;
                    break;
                case 'alt':
                    document.getElementById('Z').textContent = metaContent;
                    break;
                case 'tim':
                    document.getElementById('T').textContent = metaContent;
                    break;
                case 'nac':
                    //console.log(calculaedad(metaContent));
                    break;

                default:
                    break;
            }
        }
        var imagen4d = xmlDoc.getElementsByTagName("img")[0].getAttribute("src");
        document.getElementById("img4d").src= imagen4d;
        var pviewbox = xmlDoc.getElementsByTagName("svg")[0].getAttribute("viewBox");
        if (pviewbox) { document.getElementById('hoja4d').setAttribute('viewBox', pviewbox); };
        var tg = xmlDoc.getElementsByTagName("svg")[0].childNodes;
        for (i = 0; i < tg.length; i++) {
            if (tg[i]) {
                if (tg[i].nodeName === "polyline") {
                    poli4d(tg[i].getAttribute('id'), tg[i].getAttribute('points'), tg[i].getAttribute('style'));
                }
                if (tg[i].nodeName === "circle") {
                    circ4d(tg[i].getAttribute('id'), tg[i].getAttribute('cx'), tg[i].getAttribute('cy'), tg[i].getAttribute('r'), tg[i].getAttribute('style'))
                }
                if (tg[i].nodeName === "text") {
                    text4d(tg[i].getAttribute('id'), tg[i].getAttribute('x'), tg[i].getAttribute('y'), tg[i].getAttribute('style'), tg[i].textContent)
                }
            }
        }
    }
}
function rednOFF() {
}

function pcanvas4d(){     
    if (canvasactivo==1){        
        canvas.style.display="none"; 
        document.getElementById("canvasicon").style.stroke = 'black';             
        canvasactivo=0;         
    } else {        
        canvas.style.display="block";     
        document.getElementById("canvasicon").style.stroke = 'red';
        canvasactivo=1;         
    }
}



function cambiarColorMicrofono(color) {
    document.getElementById("elipse1").style.stroke = color;
    document.getElementById("elipse2").style.fill = color;
    document.getElementById("palo2").style.fill = color;         
    document.getElementById("palo2").style.stroke = color;
}
function microfono4d() {     
    if (micactivo == 1) {        
        microfonoOFF();        
        micactivo = 0;   
        cambiarColorMicrofono('black');      
    } else {        
        microfonoON();
        micactivo = 1;
        cambiarColorMicrofono('red');
    }
}

let recognition;
function microfonoON() {
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if ('SpeechRecognition' in window) {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        //recognition.continuous = true;
        recognition.onstart = () => {
            cambiarColorMicrofono('red');
        };
        recognition.onresult = (event) => {
            document.getElementById('subtitulos2').textContent = document.getElementById('subtitulos1').textContent;
            cambiarColorMicrofono('black');
            const transcript = event.results[0][0].transcript;
            document.getElementById('subtitulos1').textContent = transcript;
        };   
        recognition.onend = () => {
            cambiarColorMicrofono('black');
            if (micactivo == 1) { recognition.start();}
        };
        recognition.start();
    } else {
        alert('El reconocimiento de voz no es compatible.');
    }        
}
function microfonoOFF() {
    document.getElementById('subtitulos1').textContent = "";
    document.getElementById('subtitulos2').textContent = "";
    if (recognition) {
        recognition.stop();
    }
}

function poli4dp(pid, pts, sty) { if (pts.indexOf('undefined') < 0 && pts.indexOf('NaN') < 0) { var o4d; if (document.getElementById(pid)) { o4d = document.getElementById(pid); } else { o4d = document.createElementNS('http://www.w3.org/2000/svg', 'polyline'); o4d.setAttribute('shape-rendering', 'geometricPrecision'); o4d.setAttribute('id', pid); } o4d.setAttribute('points', pts); if (sty !== ' ') { o4d.setAttribute('style', sty); } if (!document.getElementById(pid)) { document.getElementById('panel4d').appendChild(o4d); }    }}

function poli4d(pid, pts, sty) {if (pts.indexOf("undefined")<0 && pts.indexOf("NaN")<0){var o4d; if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS("http://www.w3.org/2000/svg", "polyline"); o4d.setAttribute("id", pid); o4d.setAttribute("shape-rendering", "geometricPrecision"); } o4d.setAttribute("points", pts);                                                                                       if (sty !== " ") {o4d.setAttribute("style", sty);}                       if (!document.getElementById(pid)) {document.getElementById("hoja4d").appendChild(o4d);}}}
function circ4d(pid, pcx, pcy, pra, sty){if (!isNaN(pcx) && !isNaN(pcy)){var o4d; if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS('http://www.w3.org/2000/svg', 'circle');  o4d.setAttribute('shape-rendering', 'geometricPrecision'); o4d.setAttribute('id', pid);} o4d.setAttribute('cx', pcx);	o4d.setAttribute('cy', pcy); o4d.setAttribute('r', pra);	                            if (sty !== ' ') {o4d.setAttribute('style', sty);}	                     if (!document.getElementById(pid)) {document.getElementById('hoja4d').appendChild(o4d);}}}
function elip4d(pid, pcx, pcy, prx, pry, sty)                                          {var o4d; if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse'); o4d.setAttribute('shape-rendering', 'geometricPrecision'); o4d.setAttribute('id', pid);} o4d.setAttribute('cx', pcx);	o4d.setAttribute('cy', pcy); o4d.setAttribute('rx', prx); o4d.setAttribute('ry', pry);	if (sty !== ' ') {o4d.setAttribute('style', sty);}	                     if (!document.getElementById(pid)) {document.getElementById('hoja4d').appendChild(o4d);}}
function text4d(pid, px, py, sty, txt)                                                 {var o4d; if (document.getElementById(pid)) {o4d = document.getElementById(pid);} else {o4d = document.createElementNS("http://www.w3.org/2000/svg", "text");    o4d.setAttribute("shape-rendering", "geometricPrecision"); o4d.setAttribute("id", pid);} o4d.setAttribute("x", px);   o4d.setAttribute("y", py);                                                                if (sty !== " ") {o4d.setAttribute("style", sty);} o4d.textContent = txt;if (!document.getElementById(pid)) {document.getElementById("hoja4d").appendChild(o4d);}}

function numeroconcomas(numero) {var parts = numero.toString().split("."); parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");	return parts.join(".");}
</script>
</body>
</html>